steps:
  - id: 'copy terraform modules'
    name: 'ubuntu'
    volumes:
      - name: 'test'
        path: '/tests'
    args: ["cp", "-r", "terraform/gcp/modules", "."]

  - id: 'copy terraform.tf'
    name: 'ubuntu'
    volumes:
      - name: 'test'
        path: '/tests'
    args: ["cp", "-r", "terraform/gcp/modules/network/tests/main/terraform.tf", "."]

  - id: 'copy main.tf'
    name: 'ubuntu'
    volumes:
      - name: 'test'
        path: '/tests'
    args: ["cp", "-r", "terraform/gcp/modules/network/tests/main/main.tf", "."]

  - id: 'copy make.sh'
    name: 'ubuntu'
    volumes:
      - name: 'test'
        path: '/tests'
    args: ["cp", "-r", "terraform/gcp/modules/network/tests/test-codes/make.sh", "."]

  - id: 'copy inspec.yml'
    name: 'ubuntu'
    volumes:
      - name: 'test'
        path: '/tests'
    args: ["cp", "-r", "terraform/gcp/modules/network/tests/test-codes/inspec.yml", "."]

  - id: 'copy controls'
    name: 'ubuntu'
    volumes:
      - name: 'test'
        path: '/tests'
    args: ["cp", "-r", "terraform/gcp/modules/network/tests/test-codes/controls", "."]

  - id: 'terraform init'
    name: 'hashicorp/terraform:$_TERRAFORM_VERSION'
    args: ["init"]

  - id: 'terraform worspace select'
    name: 'hashicorp/terraform:$_TERRAFORM_VERSION'
    args: ["workspace", "select", "$PROJECT_ID"]

  - id: 'terraform apply'
    name: 'hashicorp/terraform:$_TERRAFORM_VERSION'
    args: ["apply", "--auto-approve"]

  - id: 'make attributes.yaml'
    name: 'ubuntu'
    args: ["sh", "make.sh"]

  - id: 'ls command tests'
    name: 'ubuntu'
    volumes:
      - name: 'test'
        path: '/tests'
    args: ["ls"]

  - id: "inspec exec"
    name: 'chef/inspec'
    args: ["exec", ".", "-t", "gcp://764086051850-6qr4p6gpi6hn506pt8ejuq83di341hur.apps.googleusercontent.com", "--input-file", "attributes.yaml", "--chef-license", "accept"]

  - id: 'terraform destroy'
    name: 'hashicorp/terraform:$_TERRAFORM_VERSION'
    args: ["destroy", "--force"]

timeout: 3600s
substitutions:
  _TERRAFORM_VERSION: 0.13.0
