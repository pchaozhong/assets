steps:
  - id: 'copy terraform modules'
    name: 'ubuntu'
    volumes:
      - name: 'test'
        path: '/tests'
    args: ["cp", "-r", $_TERRAFORM_MODULE_PATH , "."]

  - id: 'copy main.tf'
    name: 'ubuntu'
    volumes:
      - name: 'test'
        path: '/tests'
    args: ["cp", "-r", '$_TERRAFORM_FILE_PATH/main.tf', "."]

  - id: 'copy make file'
    name: 'ubuntu'
    volumes:
      - name: 'test'
        path: '/tests'
    args: ["cp", "-r", $_START_UP_PATH, "."]

  - id: 'copy terratest make file'
    name: 'ubuntu'
    volumes:
      - name: 'test'
        path: '/tests'
    args: ["cp", "-r", '${_TEST_PATH}/make.sh', "./terratest_make.sh"]

  - id: 'make attributes.yaml and terraform.tf'
    name: 'ubuntu'
    volumes:
      - name: 'test'
        path: '/tests'
    args: ["sh", "make.sh", $PROJECT_ID, $_MODULE_PREFIX]

  - id: 'make terraform.tf at terratest'
    name: 'ubuntu'
    volumes:
      - name: 'test'
        path: '/tests'
    args: ["sh", "terratest_make.sh", $PROJECT_ID, '${_TEST_PATH}/terraform.tf']

  - id: 'terraform init'
    name: 'hashicorp/terraform:$_TERRAFORM_VERSION'
    args: ["init"]

  - id: 'terraform worspace select'
    name: 'hashicorp/terraform:$_TERRAFORM_VERSION'
    args: ["workspace", "select", "$PROJECT_ID"]

  - id: 'terraform apply'
    name: 'hashicorp/terraform:$_TERRAFORM_VERSION'
    args: ["apply", "--auto-approve"]

  - id: "testing"
    name: 'gcr.io/$PROJECT_ID/terratest'
    volumes:
      - name: 'test'
        path: '/tests'
    args: ["go", "test", $_TEST_PATH, '-v']
    env:
      - 'GOOGLE_PROJECT=$PROJECT_ID'
      - 'TERRATEST_PATH=$_TEST_PATH'

  - id: 'terraform destroy'
    name: 'hashicorp/terraform:$_TERRAFORM_VERSION'
    args: ["destroy", "--force"]

timeout: 3600s
substitutions:
  _IMG_VER: 2.1.6
  _TERRAFORM_VERSION: 0.13.0
  _START_UP_PATH: ./terraform/gcp/modules/network/tests/make.sh
  _TEST_PATH: ./terraform/gcp/modules/network/tests/terratest/
  _TERRAFORM_FILE_PATH: ./terraform/gcp/modules/network/tests/main
  _TERRAFORM_MODULE_PATH: ./terraform/gcp/modules
  _MODULE_PREFIX: network
